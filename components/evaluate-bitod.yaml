name: Evaluate BiToD
description: |
  Evaluate a BiToD model
inputs:
  - {name: owner, description: ''}
  - {name: project, description: ''}
  - {name: experiment, description: ''}
  - {name: commit_hash, description: ''}
  - {name: s3_model, description: ''}
  - {name: s3_datadir, description: ''}
  - {name: image, description: ''}
  - {name: split, description: ''}
  - {name: additional_args, description: ''}
outputs:
  - {name: s3_output_dir}
implementation:
  container:
    image: '{{inputs.parameters.image}}'
    command:
    - /bin/bash
    - -e
    - -c
    - |
      . /opt/genie-toolkit/lib.sh
      parse_args "$0" "image split owner project experiment commit_hash s3_model s3_datadir s3_output_dir" "$@"
      shift $n
      set -x
      cd $HOME
      git clone https://github.com/HLTCHKUST/BiToD.git ./BiToD
      cd BiToD
      git pull -r
      git checkout ${commit_hash}
      rm -rf data
      aws s3 sync ${s3_datadir} data/
      aws s3 sync ${s3_model} models/

      python3 evaluate.py \
        --model_path models/ \
        --reference_file_path data/en_"${split}".json \
        --result_path results/ \
        $@

      S3_OUTPUT_DIR=${s3_model}/results/
      aws s3 sync --no-progress ./results/ ${S3_OUTPUT_DIR}
      mkdir -p `dirname $s3_output_dir`
      echo ${S3_OUTPUT_DIR} > $s3_output_dir
    args: [
      'cmd',
      --image, {inputValue: image},
      --split, {inputValue: split},
      --owner, {inputValue: owner},
      --project, {inputValue: project},
      --experiment, {inputValue: experiment},
      --commit_hash, {inputValue: commit_hash},
      --s3_model, {inputValue: s3_model},
      --s3_datadir, {inputValue: s3_datadir},
      --s3_output_dir, {outputPath: s3_output_dir},
      --,
      {inputValue: additional_args},
    ]
