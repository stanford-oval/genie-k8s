name: Eval
description: |
  Evaluate
inputs:
  - {name: image, description: '', default: ''}
  - {name: project, description: '', default: ''}
  - {name: owner, description: '', default: ''}
  - {name: experiment, description: '', default: ''}
  - {name: canonical, description: '', default: ''}
  - {name: model, description: '', default: ''}
  - {name: model_owner, description: '', default: ''}
  - {name: s3_data_dir, description: '', default: ''}
  - {name: s3_model_dir, description: '', default: ''}
  - {name: additional_args, description: '', default: ''}
outputs:
  - {name: metrics_output}
  - {name: s3_metrics_output}
  - {name: MLPipeline UI metadata, type: UI metadata}
  - {name: MLPipeline Metrics, type: Metrics}
implementation:
  container:
    image: '{{inputs.parameters.image}}'
    command:
    - /bin/bash
    - -ex
    - -c 
    - |
      . /opt/genie-toolkit/lib.sh
      parse_args "$0" "image project owner experiment canonical model model_owner s3_data_dir s3_model_dir s3_metrics_output metrics_output" "$@"
      shift $n
      cd $HOME

      /opt/genie-toolkit/sync-repos.sh 
      MAKEDIR=`get_make_dir ${project}`
      cd workdir/${MAKEDIR}

      cat >> config.mk <<EOF
      developer_key = ${THINGPEDIA_DEVELOPER_KEY}
      EOF

      export TZ=America/Los_Angeles
      export TS_NODE_TRANSPILE_ONLY=true
      npm install
      npm i ts-node

      mkdir -p ${canonical}/models/${model}/
      aws s3 cp --no-progress ${s3_data_dir}/${canonical}/manifest.tt ${canonical}/manifest.tt
      aws s3 cp --no-progress ${s3_data_dir}/${canonical}/test.tsv ${canonical}/test.tsv
      aws s3 sync --no-progress ${s3_model_dir}/ ${canonical}/models/${model}/
      
      make model=${model} eval_set=eval_synthetic experiment=${canonical} evaluate
      
      aws s3 cp --no-progress ${canonical}/eval_synthetic/${model}.results ${s3_model_dir}/${model}.results
      aws s3 cp --no-progress ${canonical}/eval_synthetic/${model}.debug ${s3_model_dir}/${model}.debug

    args: [
      'cmd',
      --image, {inputValue: image},
      --owner, {inputValue: owner},
      --project, {inputValue: project},
      --experiment, {inputValue: experiment},
      --canonical, {inputValue: canonical},
      --model, {inputValue: model},
      --model_owner, {inputValue: model_owner},
      --s3_data_dir, {inputValue: s3_data_dir},
      --s3_model_dir, {inputValue: s3_model_dir},
      --s3_metrics_output, {outputPath: s3_metrics_output},
      --metrics_output, {outputPath: metrics_output},
      --, {inputValue: additional_args}
    ]

    fileOutputs:
      MLPipeline UI metadata: /tmp/mlpipeline-ui-metadata.json
      MLPipeline Metrics: /tmp/mlpipeline-metrics.json
