name: Generic
description: |
  Run any Make command in a GPU VM
inputs:
  - {name: image, description: '', default: ''}
  - {name: storage_input_folder, description: 'owner/project/experiment/storage_input_folder will be downloaded to ./input/ before the script starts'}
  - {name: project, description: '', default: ''}
  - {name: owner, description: '', default: ''}
  - {name: experiment, description: '', default: ''}
  - {name: s3_bucket, description: '', default: ''}
  - {name: additional_args, description: '', default: ''}
outputs:
  - {name: s3_output_dir}
implementation:
  container:
    image: '{{inputs.parameters.image}}'
    command:
    - /bin/bash
    - -ex
    - -c
    - |
      . /opt/genie-toolkit/lib.sh
      parse_args "$0" "image storage_input_folder project owner experiment s3_bucket s3_output_dir" "$@"
      shift $n
      cd $HOME


      /opt/genie-toolkit/sync-repos.sh

      set +x
      keyctl session ; export AZCOPY_SPA_CLIENT_SECRET=${AZURE_SP_PASSWORD} ; azcopy login --service-principal --application-id ${AZURE_SP_APP_ID} --tenant-id ${AZURE_SP_TENANT_ID}
      set -x

      if test "${storage_input_folder}" != None ; then
        mkdir -p ./input/
        azcopy sync --recursive ${s3_bucket%/}/${storage_input_folder%/}/ ./input/
      fi


    args: [
      'cmd',
      --image, {inputValue: image},
      --storage_input_folder, {inputValue: storage_input_folder},
      --project, {inputValue: project},
      --owner, {inputValue: owner},
      --experiment, {inputValue: experiment},
      --s3_bucket, {inputValue: s3_bucket},
      --s3_output_dir, {outputPath: s3_output_dir},
      --, {inputValue: additional_args}
    ]