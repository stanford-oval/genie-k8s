name: Bootleg
description: |
  Named Entity Disambiguation
inputs:
  - {name: image, description: ''}
  - {name: s3_bucket, description: ''}
  - {name: owner, description: ''}
  - {name: task_name, description: ''}
  - {name: project, description: ''}
  - {name: experiment, description: ''}
  - {name: model, description: ''}
  - {name: load_from, description: ''}
  - {name: eval_set, description: ''}
  - {name: s3_datadir, description: ''}
  - {name: s3_database_dir, description: ''}
  - {name: dataset_subfolder, description: ''}
  - {name: skip_tensorboard, description: ''}
  - {name: train_languages, description: ''}
  - {name: eval_languages, description: ''}
  - {name: dlg_side, description: ''}
  - {name: additional_args, description: ''}
outputs:
  - {name: s3_bootleg_prepped_data}
implementation:
  container:
    image: '{{inputs.parameters.image}}'
    command:
    - /bin/bash
    - -ex
    - -c
    - |
      . /opt/genie-toolkit/lib.sh

      parse_args "$0" "image s3_bucket owner task_name project experiment model load_from eval_set s3_datadir s3_database_dir dataset_subfolder skip_tensorboard train_languages eval_languages dlg_side s3_bootleg_prepped_data" "$@"
      shift $n 
      cd $HOME

      /opt/genie-toolkit/sync-repos.sh

      IFS='+' ; read -ra TLS <<<"$train_languages"; IFS=' '
      echo "${TLS[@]}"
      IFS='+'; read -ra ELS <<<"$eval_languages"; IFS=' '
      echo "${ELS[@]}"

      modeldir="$HOME/models/$model"
      mkdir -p "$modeldir"

      if test "{s3_database_dir}" != None ; then
        aws s3 sync --no-progress ${s3_database_dir} ./database/ --exclude '*' --include '*.json' --include '*bootleg_wiki*' --include '*emb_data*' --include '*entity_db*'
      fi

      load_args=
      if test "${load_from}" != None ; then 
        aws s3 sync --no-progress "${load_from}" "$modeldir"/ --exclude "iteration_*.pth" --exclude "*eval/*"  --exclude "*.log"
        load_args="--load best.pth"
      fi

      if [[ "$task_name" == *"multilingual"* ]] ; then
        for lang in "${TLS[@]}" "${ELS[@]}" ; do
          aws s3 sync --no-progress ${s3_datadir} ${HOME}/dataset/ --exclude "*" --include "*$lang*"
        done
        mkdir -p $modeldir/dataset/almond/multilingual
        ln -s ${HOME}/dataset/* $modeldir/dataset/almond/multilingual
      elif [[ "$task_name" == *"dialog"* || "$task_name" == *"contextual"* ]] ; then
        aws s3 sync --no-progress --exclude "synthetic*.txt" ${s3_datadir} dataset/
        mkdir -p $modeldir/dataset/almond/${dlg_side}
        ln -s ${HOME}/dataset/* $modeldir/dataset/almond/${dlg_side}
      else
        aws s3 sync --no-progress ${s3_datadir} dataset/
        mkdir -p $modeldir/dataset/almond/
        ln -s ${HOME}/dataset/* $modeldir/dataset/almond/
      fi

      rm -fr "$modeldir/dataset"
      mkdir "$modeldir/dataset"
      rm -fr "$modeldir/cache"
      mkdir -p "$modeldir/cache"
      ln -s $modeldir /home/genie-toolkit/current
      mkdir -p "/shared/tensorboard/${project}/${experiment}/${owner}/${model}"
     
      tensorboard_args=
      if test "$skip_tensorboard" != "true" ; then
        tensorboard_args="--tensorboard_dir /shared/tensorboard/${project}/${experiment}/${owner}/${model}"
      fi

      ls -R
     
      genienlp train \
          --data "$modeldir/dataset" \
          --save "$modeldir" \
          ${tensorboard_args} \
          --cache "$modeldir/cache" \
          --train_tasks ${task_name} \
          --preserve_case \
          --exist_ok \
          --skip_cache \
          --eval_set_name $eval_set \
          --train_languages $train_languages \
          --eval_languages $eval_languages \
          --do_ner
          --retrieve_method bootleg \
          --bootleg_input_dir ./database/ \
          --bootleg_dump_features
          ${load_args} \
          $@ 

      rm -fr "$modeldir/cache"
      rm -fr "$modeldir/dataset"
      S3_BOOTLEG_PREPPED_DATA=s3://${s3_bucket}/${owner}/models/${project}/${experiment}/bootleg/prepped_files/

      aws s3 sync --no-progress results_temp ${S3_BOOTLEG_PREPPED_DATA}
            
      mkdir -p `dirname $s3_bootleg_prepped_data`
      echo ${S3_BOOTLEG_PREPPED_DATA} > $s3_bootleg_prepped_data
    
    args: [
      'cmd',
      --image, {inputValue: image},
      --s3_bucket, {inputValue: s3_bucket},
      --owner, {inputValue: owner},
      --task_name, {inputValue: task_name},
      --project, {inputValue: project},
      --experiment, {inputValue: experiment},
      --model, {inputValue: model},
      --load_from, {inputValue: load_from},
      --eval_set, {inputValue: eval_set},
      --s3_datadir, {inputValue: s3_datadir},
      --s3_database_dir, {inputValue: s3_database_dir},
      --dataset_subfolder, {inputValue: dataset_subfolder},
      --s3_bootleg_prepped_data, {outputPath: s3_bootleg_prepped_data},
      --skip_tensorboard, {inputValue: skip_tensorboard},
      --train_languages, {inputValue: train_languages},
      --eval_languages, {inputValue: eval_languages},
      --dlg_side, {inputValue: dlg_side},
      --,
      {inputValue: additional_args},
    ]
    
